@inject ILogger<MudInputWithUnitAdornment> logger
@inject ISnackbar Snackbar


<MudPaper Class="my-2 mx-2 py-2 my-2" Style="@($"background:{DataUtils.FLOATING_COLOUR};")">
    <MudPaper Class="my-1 mx-1 py-1 my-1">
        <MudToolBar>
            <MudText Typo="Typo.h6" Class="mx-2 px-2">Edit Trajectory</MudText>
            <MudButton StartIcon="@Icons.Material.Filled.SaveAs" Variant="Variant.Filled" IconColor="Color.Primary" OnClick="SaveAsTrajectory">Save new</MudButton>
            @if (TrajectoryId != null)
            {
                <MudButton StartIcon="@Icons.Material.Filled.Save" Variant="Variant.Filled" IconColor="Color.Primary" OnClick="SaveTrajectory">Save</MudButton>
            }
            <MudSpacer />
            <MudButton StartIcon="@Icons.Material.Filled.Close" Variant="Variant.Filled" IconColor="Color.Error" OnClick="SendMessage">Close</MudButton>                
        </MudToolBar>
        <MudDivider Class="py-1 my-1"/>
        <MudForm @ref="form" Class="mx-2 my-2">
            <MudTextField @bind-Value="currentTrajectory.Name" Label="Name" Required="true" For="@(() => currentTrajectory.Name)" />
            <MudTextField @bind-Value="currentTrajectory.Description" Label="Description" For="@(() => currentTrajectory.Description)" />
        </MudForm>
    </MudPaper>
</MudPaper>

@code{
     [CascadingParameter]
    private MudUnitAndReferenceChoiceTag? Parent { get; set; }
    [Parameter]
    public Guid? TrajectoryId { get; set; }
    [Parameter]
    public EventCallback ValueChanged {get; set;}    


    private Trajectory currentTrajectory = PseudoConstructors.ConstructTrajectory();
    private MudForm form;

    protected override async Task OnInitializedAsync()
    {
        if (TrajectoryId != null)
        {
            currentTrajectory = await APIUtils.ClientTrajectory.GetTrajectoryByIdAsync(TrajectoryId.Value);
        }
        await InvokeAsync(() => { StateHasChanged(); });
    }

    //Send message to parent component
    private async Task SendMessage()
    {
        await ValueChanged.InvokeAsync();
    }  
    //Add/Edit panel controls
    private async Task SaveTrajectory()
    {
        try
        {
            if (TrajectoryId != null)
            {
                await APIUtils.ClientTrajectory.PutTrajectoryByIdAsync((Guid) TrajectoryId, currentTrajectory);
                Snackbar.Add("Trajectory updated successfully", Severity.Success);
                await SendMessage();
            }
            else
            {
                Snackbar.Add("Trajectory not found for edition", Severity.Success);
            }

        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Error saving Trajectory");
            Snackbar.Add("Error saving Trajectory: " + ex.Message, Severity.Warning);
        }
    }
    private async Task SaveAsTrajectory()
    {
        try
        {
            if (TrajectoryId != null)
            {
                await APIUtils.ClientTrajectory.PostTrajectoryAsync(currentTrajectory);
                Snackbar.Add("Trajectory updated successfully", Severity.Success);
                await SendMessage();
            }
            else
            {
                Snackbar.Add("Trajectory not found for edition", Severity.Success);
            }

        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Error saving Trajectory");
            Snackbar.Add("Error saving Trajectory: " + ex.Message, Severity.Warning);
        }
    }      

    //Update unit system
    private void ManageUnits(){}        
}